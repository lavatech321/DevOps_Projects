---
- name: installing samba server
  hosts: localhost
  vars:
    ansible_python_interpreter: /usr/bin/python3.6
    services:
      - smb
    package_list:
      - samba
      - samba-client
      - python3-firewall
    firewall_service:
      - samba
    samba_users:
      - rohit
      - sudhanshu
    samba_cred:
      rohit: r@12345
      sudhanshu: s@12345

  tasks:
    - name: installing packages
      yum:
        name: "{{ item }}"
        state: present
      loop: "{{ package_list }}"

    - name: create a directory
      file:
        path: /smbshared
        state: directory
        owner: root
        group: root
        mode: '777'

    - name: create a user
      user:
        name: "{{ item }}"
        state: present
      loop: "{{ samba_users }}"

    - name: Adding into samba user
      shell: echo -ne "{{ item.value }}\n{{ item.value }}\n" | smbpasswd -a -s "{{ item.key }}"
      loop: "{{ samba_cred | dict2items }}"

    - name: Samba database
      shell: "pdbedit -wL"
      register: db

    - name: Display samba database
      debug:
        msg: "{{ db.stdout }}"

    - name: adding content in samba config file
      blockinfile:
        path: /etc/samba/smb.conf
        block: |
          [tester]
                comment = smb dir for testing team
                path = /smbshared
                valid users = rohit, sudhanshu
                write list = sudhanshu
      notify:
        - restart_me

    - name: service restart
      service:
        name: "{{item}}"
        state: restarted
      loop: "{{services}}"

    - name: Enable firewall services for samba
      firewalld:
        service: "{{ item }}"
        permanent: yes
        state: enabled
      loop: "{{ firewall_service }}"

    - name: Put SELinux in permissive mode
      selinux:
        policy: targeted
        state: permissive

    - name: Test samba settings
      shell: testparm
      register: result

    - name: Display samba settings result
      debug:
        msg: "{{ result.stdout_lines }}"



  handlers:   
    - name: restart_me
      service:
        name: smb
        state: reloaded

